<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>For Divija | Born of Heaven</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@300;400;600&family=Cormorant+Garamond:ital,wght@0,300;0,400;1,300;1,400&display=swap" rel="stylesheet">
    <style>
        :root {
            --void: #030305;
            --nebula: #0a0f1a;
            --stardust: #1a1f2e;
            --celestial: #e8e8f0;
            --moonlight: #c5c5d5;
            --aurora: #7b68ee;
            --ethereal: #00d4aa;
            --gold-dust: #d4af37;
            --shadow-depth: rgba(0, 0, 0, 0.7);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            background: var(--void);
            color: var(--celestial);
            font-family: 'Cormorant Garamond', Georgia, serif;
            overflow-x: hidden;
            min-height: 100vh;
            line-height: 1.7;
        }

        /* ===== COSMIC BACKGROUND ===== */
        #cosmos {
            position: fixed;
            inset: 0;
            z-index: -2;
            background: radial-gradient(ellipse at 50% 100%, var(--nebula) 0%, var(--void) 60%);
        }

        #starfield {
            position: fixed;
            inset: 0;
            z-index: -1;
        }

        /* ===== ENTRY PORTAL ===== */
        #portal {
            position: fixed;
            inset: 0;
            background: var(--void);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: opacity 0.8s cubic-bezier(0.4, 0, 0.2, 1), visibility 0.8s;
        }

        #portal.dissolved {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        .portal-text {
            text-align: center;
        }

        .portal-title {
            font-family: 'Cinzel', serif;
            font-size: clamp(2.5rem, 6vw, 5rem);
            font-weight: 300;
            letter-spacing: 0.3em;
            text-transform: uppercase;
            background: linear-gradient(180deg, var(--celestial) 0%, var(--moonlight) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5em;
            opacity: 0;
            transform: translateY(30px);
        }

        .portal-title.visible {
            opacity: 1;
            transform: translateY(0);
            transition: all 0.7s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .portal-subtitle {
            font-size: 1rem;
            letter-spacing: 0.5em;
            color: var(--aurora);
            text-transform: uppercase;
            opacity: 0;
        }

        .portal-subtitle.visible {
            opacity: 0.9;
            transition: opacity 0.7s ease 0.25s;
        }

        .enter-btn {
            margin-top: 3rem;
            padding: 1rem 3rem;
            background: transparent;
            border: 1px solid rgba(123, 104, 238, 0.4);
            color: var(--celestial);
            font-family: 'Cinzel', serif;
            font-size: 0.9rem;
            letter-spacing: 0.3em;
            text-transform: uppercase;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 0;
        }

        .enter-btn.visible {
            opacity: 1;
            transition: opacity 0.7s ease 0.5s;
        }

        .enter-btn::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, transparent, rgba(123, 104, 238, 0.2), transparent);
            transform: translateX(-100%);
            transition: transform 0.5s;
        }

        .enter-btn:hover {
            border-color: var(--ethereal);
            box-shadow: 0 0 30px rgba(0, 212, 170, 0.2);
            transform: scale(1.02);
        }

        .enter-btn:hover::before {
            transform: translateX(100%);
        }

        /* ===== MAIN CONTENT ===== */
        #universe {
            opacity: 0;
            transition: opacity 1.5s ease;
        }

        #universe.revealed {
            opacity: 1;
        }

        .celestial-section {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 5rem 2rem;
            position: relative;
        }

        /* ===== TITLE SECTION ===== */
        .title-constellation {
            text-align: center;
            margin-bottom: 3rem;
        }

        .divine-name {
            font-family: 'Cinzel', serif;
            font-size: clamp(3rem, 8vw, 6rem);
            font-weight: 300;
            letter-spacing: 0.2em;
            background: linear-gradient(135deg, var(--celestial) 0%, var(--gold-dust) 50%, var(--celestial) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            position: relative;
        }

        .name-meaning {
            font-size: 1.1rem;
            letter-spacing: 0.4em;
            color: var(--aurora);
            text-transform: uppercase;
            margin-top: 1rem;
            opacity: 0.9;
        }

        .milestone-text {
            font-size: 1rem;
            letter-spacing: 0.2em;
            color: var(--moonlight);
            margin-top: 2rem;
            font-style: italic;
        }

        /* ===== MUSIC ORBIT ===== */
        .music-orbit {
            background: rgba(10, 15, 26, 0.6);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(123, 104, 238, 0.15);
            border-radius: 50px;
            padding: 1.5rem 2.5rem;
            display: flex;
            align-items: center;
            gap: 1.5rem;
            margin: 2rem 0;
            transition: all 0.4s ease;
        }

        .music-orbit:hover {
            border-color: rgba(0, 212, 170, 0.3);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
        }

        .play-pulse {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--aurora), var(--ethereal));
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            position: relative;
            flex-shrink: 0;
        }

        .play-pulse::after {
            content: '';
            position: absolute;
            inset: -5px;
            border-radius: 50%;
            border: 1px solid var(--aurora);
            opacity: 0;
        }

        .play-pulse.playing::after {
            animation: pulse-ring 1.5s infinite;
        }

        @keyframes pulse-ring {
            0% { transform: scale(1); opacity: 0.5; }
            100% { transform: scale(1.5); opacity: 0; }
        }

        .play-pulse:hover {
            transform: scale(1.1);
        }

        .play-icon, .pause-icon {
            transition: all 0.3s ease;
        }

        .play-icon {
            width: 0;
            height: 0;
            border-style: solid;
            border-width: 8px 0 8px 14px;
            border-color: transparent transparent transparent var(--void);
            margin-left: 3px;
        }

        .pause-icon {
            width: 14px;
            height: 16px;
            background: linear-gradient(to right, var(--void) 40%, transparent 40%, transparent 60%, var(--void) 60%);
        }

        .track-details {
            flex: 1;
        }

        .track-name {
            font-family: 'Cinzel', serif;
            font-size: 0.95rem;
            letter-spacing: 0.15em;
            color: var(--celestial);
        }

        .track-artist {
            font-size: 0.85rem;
            color: var(--moonlight);
            opacity: 0.7;
            margin-top: 0.2rem;
        }

        .visualizer {
            display: flex;
            align-items: flex-end;
            gap: 3px;
            height: 30px;
            width: 60px;
        }

        .v-bar {
            flex: 1;
            background: linear-gradient(to top, var(--aurora), var(--ethereal));
            border-radius: 2px;
            min-height: 4px;
            transition: height 0.05s ease;
        }

        /* ===== MEMORY CONSTELLATION ===== */
        .memory-constellation {
            width: 100%;
            max-width: 1200px;
            margin: 4rem auto;
            display: grid;
            grid-template-columns: 1fr 1.5fr;
            gap: 3rem;
            align-items: center;
        }

        .portrait-frame {
            position: relative;
            aspect-ratio: 3/4;
            overflow: hidden;
            border: 1px solid rgba(123, 104, 238, 0.2);
        }

        .portrait-frame::before {
            content: '';
            position: absolute;
            inset: 10px;
            border: 1px solid rgba(212, 175, 55, 0.3);
            z-index: 1;
            pointer-events: none;
        }

        .portrait-frame img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            filter: grayscale(30%) contrast(1.1);
            transition: all 0.6s ease;
        }

        .portrait-frame:hover img {
            filter: grayscale(0%) contrast(1);
            transform: scale(1.03);
        }

        .landscape-pair {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .landscape-frame {
            position: relative;
            aspect-ratio: 16/9;
            overflow: hidden;
            border: 1px solid rgba(123, 104, 238, 0.2);
        }

        .landscape-frame::before {
            content: '';
            position: absolute;
            inset: 8px;
            border: 1px solid rgba(212, 175, 55, 0.2);
            z-index: 1;
            pointer-events: none;
        }

        .landscape-frame img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            filter: grayscale(30%) contrast(1.1);
            transition: all 0.6s ease;
        }

        .landscape-frame:hover img {
            filter: grayscale(0%) contrast(1);
            transform: scale(1.03);
        }

        .image-fallback {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--stardust);
            color: var(--moonlight);
            font-family: 'Cinzel', serif;
            font-size: 0.9rem;
            letter-spacing: 0.2em;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .image-fallback.visible {
            opacity: 1;
        }

        /* ===== LETTER NEBULA ===== */
        .letter-nebula {
            max-width: 800px;
            margin: 0 auto;
            padding: 4rem;
            background: linear-gradient(180deg, rgba(10, 15, 26, 0.4) 0%, rgba(26, 31, 46, 0.2) 100%);
            border-left: 2px solid var(--aurora);
            position: relative;
        }

        .letter-nebula::before {
            content: '';
            position: absolute;
            top: 0;
            left: -2px;
            width: 2px;
            height: 100px;
            background: linear-gradient(to bottom, var(--ethereal), var(--aurora));
        }

        .letter-content {
            font-size: 1.15rem;
            line-height: 2.2;
            color: var(--moonlight);
        }

        .letter-content p {
            margin-bottom: 1.8rem;
            opacity: 0;
            transform: translateY(20px);
        }

        .letter-content p.revealed {
            opacity: 1;
            transform: translateY(0);
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .highlight-gold {
            color: var(--gold-dust);
            font-weight: 400;
        }

        .highlight-aurora {
            color: var(--aurora);
            font-weight: 400;
        }

        .highlight-ethereal {
            color: var(--ethereal);
            font-weight: 400;
        }

        .emphasis {
            font-style: italic;
            color: var(--celestial);
        }

        /* ===== FINAL CONSTELLATION ===== */
        .final-constellation {
            text-align: center;
            padding: 6rem 2rem;
            min-height: 60vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .punchline {
            font-family: 'Cinzel', serif;
            font-size: clamp(1.5rem, 4vw, 2.5rem);
            letter-spacing: 0.15em;
            color: var(--ethereal);
            line-height: 1.8;
            opacity: 0;
            transform: scale(0.95);
        }

        .punchline.revealed {
            opacity: 1;
            transform: scale(1);
            transition: all 1s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .punchline .daddy-highlight {
            color: var(--gold-dust);
            text-shadow: 0 0 30px rgba(212, 175, 55, 0.5);
            font-weight: 600;
            display: inline-block;
            animation: daddy-glow 2s ease-in-out infinite;
        }

        @keyframes daddy-glow {
            0%, 100% { text-shadow: 0 0 20px rgba(212, 175, 55, 0.4); }
            50% { text-shadow: 0 0 40px rgba(212, 175, 55, 0.7); }
        }

        .signature {
            font-family: 'Cinzel', serif;
            font-size: 1.3rem;
            letter-spacing: 0.3em;
            color: var(--aurora);
            margin-top: 4rem;
            opacity: 0;
        }

        .signature.revealed {
            opacity: 1;
            transition: opacity 1s ease 0.5s;
        }

        /* ===== SCROLL REVEAL ===== */
        .scroll-reveal {
            opacity: 0;
            transform: translateY(30px);
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .scroll-reveal.visible {
            opacity: 1;
            transform: translateY(0);
        }

        /* ===== FLOATING PARTICLES ===== */
        .particle {
            position: fixed;
            width: 2px;
            height: 2px;
            background: var(--gold-dust);
            border-radius: 50%;
            pointer-events: none;
            opacity: 0;
            z-index: -1;
        }

        /* ===== MOBILE ===== */
        @media (max-width: 768px) {
            .memory-constellation {
                grid-template-columns: 1fr;
            }
            
            .letter-nebula {
                padding: 2rem;
            }
            
            .celestial-section {
                padding: 3rem 1.5rem;
            }

            .music-orbit {
                padding: 1rem 1.5rem;
                flex-wrap: wrap;
                justify-content: center;
            }

            .visualizer {
                width: 100%;
                justify-content: center;
                margin-top: 0.5rem;
            }
        }
    </style>
<base target="_blank">
</head>
<body>
    <!-- COSMIC BACKGROUND -->
    <div id="cosmos"></div>
    <canvas id="starfield"></canvas>

    <!-- ENTRY PORTAL -->
    <div id="portal">
        <div class="portal-text">
            <h1 class="portal-title" id="portal-title">Divija</h1>
            <p class="portal-subtitle" id="portal-subtitle">Born of Heaven</p>
        </div>
        <button class="enter-btn" id="enter-btn">Enter Our Universe</button>
    </div>

    <!-- MAIN UNIVERSE -->
    <main id="universe">
        <!-- TITLE CONSTELLATION -->
        <section class="celestial-section">
            <div class="title-constellation scroll-reveal">
                <h1 class="divine-name">DIVIJA</h1>
                <p class="name-meaning">Heavenly Born · Divine Light</p>
                <p class="milestone-text">One Year. One Journey. One Love.</p>
            </div>

            <!-- MUSIC ORBIT -->
            <div class="music-orbit scroll-reveal">
                <button class="play-pulse" id="play-btn" aria-label="Play music">
                    <div class="play-icon" id="play-icon"></div>
                </button>
                <div class="track-details">
                    <div class="track-name">Fallen Down</div>
                    <div class="track-artist">Our Song</div>
                </div>
                <div class="visualizer" id="visualizer"></div>
                <audio id="bg-music" loop crossorigin="anonymous" preload="none">
                    <source src="fallen-down.mp3" type="audio/mpeg">
                </audio>
            </div>
        </section>

        <!-- MEMORY CONSTELLATION -->
        <section class="celestial-section">
            <div class="memory-constellation scroll-reveal">
                <div class="portrait-frame" id="frame-k1">
                    <img src="K1.png" alt="Divija" loading="lazy" decoding="async">
                    <div class="image-fallback">Memory K1</div>
                </div>
                <div class="landscape-pair">
                    <div class="landscape-frame" id="frame-k2">
                        <img src="K2.png" alt="Our Memory" loading="lazy" decoding="async">
                        <div class="image-fallback">Memory K2</div>
                    </div>
                    <div class="landscape-frame" id="frame-k3">
                        <img src="K3.png" alt="Our Journey" loading="lazy" decoding="async">
                        <div class="image-fallback">Memory K3</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- LETTER NEBULA -->
        <section class="celestial-section">
            <div class="letter-nebula scroll-reveal">
                <div class="letter-content" id="letter">
                    <p>My <span class="highlight-gold">Divija</span>,</p>
                    
                    <p>When we first met, I won't lie—I was <span class="emphasis">irritated</span>. You came across as rude, immature, someone I had no patience for. I dismissed you before I even knew you.</p>
                    
                    <p>But something made me stay. Something made me look <span class="highlight-aurora">beyond</span> that sharp tongue, beyond the walls you built so high. And when I did, I discovered what you couldn't see in yourself—a <span class="highlight-gold">gem</span> hidden beneath layers of self-protection.</p>
                    
                    <p>You've always been the <span class="highlight-ethereal">tough cookie</span>, haven't you? Independent to a fault, working tirelessly, solving problems with that <span class="highlight-aurora">brilliant mathematical mind</span> of yours. You look down on yourself, failing to see the <span class="highlight-gold">extraordinary value</span> you carry. But I see it. I've always seen it.</p>
                    
                    <p>Through every memory we've built, every moment shared, I've written <span class="highlight-aurora">notes</span> in my heart—each one a testament to how deeply I've fallen. You became my constant thought, my gravitational center.</p>
                    
                    <p>And now, looking at you today, I can finally rest my heart. You've reached a <span class="highlight-gold">milestone</span> of maturity that leaves me in awe. The growth, the transformation—it's nothing short of <span class="highlight-ethereal">divine</span>.</p>
                    
                    <p>You are <span class="highlight-ethereal">skilled</span>, <span class="highlight-ethereal">brilliant</span>, and <span class="highlight-gold">loved</span> beyond measure. Never forget that.</p>
                    
                    <p>I love you.</p>
                </div>
            </div>
        </section>

        <!-- FINAL CONSTELLATION -->
        <section class="final-constellation">
            <div class="punchline" id="punchline">
                As much as you may hate to hear this:<br>
                I will always be <span class="daddy-highlight">DADDY</span>
            </div>
            <div class="signature" id="signature">
                Forever Yours
            </div>
        </section>
    </main>

    <script>
    // ===== FUNCTIONAL PROGRAMMING CORE =====
    const pipe = (...fns) => (x) => fns.reduce((v, f) => f(v), x);
    const compose = (...fns) => (x) => fns.reduceRight((v, f) => f(v), x);
    const curry = (fn) => (...args) => 
        args.length >= fn.length ? fn(...args) : curry(fn.bind(null, ...args));
    
    const memoize = (fn, limit = 100) => {
        const cache = new Map();
        return (...args) => {
            const key = JSON.stringify(args);
            if (cache.has(key)) {
                const val = cache.get(key);
                cache.delete(key);
                cache.set(key, val);
                return val;
            }
            if (cache.size >= limit) {
                const firstKey = cache.keys().next().value;
                cache.delete(firstKey);
            }
            const result = fn(...args);
            cache.set(key, result);
            return result;
        };
    };

    const throttle = (fn, ms) => {
        let last = 0;
        return (...args) => {
            const now = Date.now();
            if (now - last >= ms) {
                last = now;
                fn(...args);
            }
        };
    };

    const lazy = (fn) => {
        let evaluated = false;
        let result;
        return () => {
            if (!evaluated) {
                result = fn();
                evaluated = true;
            }
            return result;
        };
    };

    // ===== RUST-INSPIRED RESULT TYPE =====
    const Result = {
        Ok: (value) => ({ 
            ok: true, value, 
            map: (f) => Result.Ok(f(value)), 
            unwrap: () => value,
            unwrapOr: () => value
        }),
        Err: (error) => ({ 
            ok: false, error, 
            map: () => Result.Err(error), 
            unwrap: () => { throw error; },
            unwrapOr: (defaultVal) => defaultVal
        }),
        tryCatch: (fn) => {
            try { return Result.Ok(fn()); } catch (e) { return Result.Err(e); }
        }
    };

    // ===== OPTION TYPE =====
    const Option = {
        Some: (value) => ({
            isSome: true,
            isNone: false,
            map: (f) => Option.Some(f(value)),
            getOrElse: () => value
        }),
        None: () => ({
            isSome: false,
            isNone: true,
            map: () => Option.None(),
            getOrElse: (defaultVal) => defaultVal
        }),
        fromNullable: (val) => val == null ? Option.None() : Option.Some(val)
    };

    // ===== STARFIELD SYSTEM =====
    const Starfield = (() => {
        const canvas = document.getElementById('starfield');
        const ctx = canvas.getContext('2d', { alpha: false });
        
        let width = 0, height = 0;
        let animationId = null;
        let isActive = true;

        const STAR_COUNT = 500;
        const BYTES_PER_STAR = 20;
        const starBuffer = new ArrayBuffer(STAR_COUNT * BYTES_PER_STAR);
        const stars = new Float32Array(starBuffer);
        const colors = ['#ffffff', '#7b68ee', '#00d4aa'];
        const colorIndices = new Uint8Array(STAR_COUNT);

        const initStars = () => {
            for (let i = 0; i < STAR_COUNT; i++) {
                const idx = i * 5;
                stars[idx] = (Math.random() - 0.5) * 2;
                stars[idx + 1] = (Math.random() - 0.5) * 2;
                stars[idx + 2] = Math.random() * 800 + 200;
                stars[idx + 3] = Math.random() * 1.2 + 0.3;
                stars[idx + 4] = Math.random();
                colorIndices[i] = Math.random() > 0.9 ? (Math.random() > 0.5 ? 1 : 2) : 0;
            }
        };

        const resize = () => {
            width = window.innerWidth;
            height = window.innerHeight;
            canvas.width = width;
            canvas.height = height;
        };

        const render = () => {
            if (!isActive) return;
            
            if (document.hidden) {
                animationId = requestAnimationFrame(render);
                return;
            }

            ctx.fillStyle = 'rgba(3, 3, 5, 0.2)';
            ctx.fillRect(0, 0, width, height);

            const cx = width / 2;
            const cy = height / 2;
            const time = Date.now() * 0.001;

            for (let i = 0; i < STAR_COUNT; i++) {
                const idx = i * 5;
                let x = stars[idx];
                let y = stars[idx + 1];
                let z = stars[idx + 2];
                const size = stars[idx + 3];
                const twinkle = stars[idx + 4];

                z -= 0.3;
                if (z < 50) {
                    z = 1000;
                    stars[idx] = (Math.random() - 0.5) * 2;
                    stars[idx + 1] = (Math.random() - 0.5) * 2;
                }
                stars[idx + 2] = z;

                const scale = 400 / z;
                const sx = x * scale * width + cx;
                const sy = y * scale * height + cy;
                const ss = size * scale;

                if (sx > -ss && sx < width + ss && sy > -ss && sy < height + ss) {
                    const alpha = Math.min(1, (1000 - z) / 400) * 
                                  (0.7 + 0.3 * Math.sin(time * 2 + twinkle * 10));
                    
                    ctx.globalAlpha = alpha;
                    ctx.fillStyle = colors[colorIndices[i]];
                    ctx.beginPath();
                    ctx.arc(sx, sy, ss, 0, Math.PI * 2);
                    ctx.fill();
                }
            }

            animationId = requestAnimationFrame(render);
        };

        const start = () => {
            if (animationId) return;
            isActive = true;
            render();
        };

        const stop = () => {
            isActive = false;
            if (animationId) {
                cancelAnimationFrame(animationId);
                animationId = null;
            }
        };

        const init = () => {
            resize();
            initStars();
            window.addEventListener('resize', throttle(resize, 200), { passive: true });
            start();
        };

        return { init, start, stop };
    })();

    // ===== AUDIO SYSTEM =====
    const AudioSystem = (() => {
        const audio = document.getElementById('bg-music');
        const playBtn = document.getElementById('play-btn');
        const playIcon = document.getElementById('play-icon');
        const visualizer = document.getElementById('visualizer');

        let audioCtx = null;
        let analyser = null;
        let dataArray = null;
        let isPlaying = false;
        let visualizerId = null;
        let bars = [];

        const createBars = lazy(() => {
            const fragment = document.createDocumentFragment();
            const barElements = [];
            for (let i = 0; i < 16; i++) {
                const bar = document.createElement('div');
                bar.className = 'v-bar';
                bar.style.height = '4px';
                fragment.appendChild(bar);
                barElements.push(bar);
            }
            visualizer.appendChild(fragment);
            return barElements;
        });

        const initAudioContext = () => {
            if (audioCtx) return Result.Ok({ ctx: audioCtx, analyser, dataArray });
            
            return Result.tryCatch(() => {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const src = ctx.createMediaElementSource(audio);
                const anal = ctx.createAnalyser();
                anal.fftSize = 32;
                anal.smoothingTimeConstant = 0.8;
                src.connect(anal);
                anal.connect(ctx.destination);
                
                audioCtx = ctx;
                analyser = anal;
                dataArray = new Uint8Array(anal.frequencyBinCount);
                return { ctx, analyser, dataArray };
            });
        };

        const updateVisualizer = () => {
            if (!isPlaying || !analyser) return;
            
            analyser.getByteFrequencyData(dataArray);
            if (bars.length === 0) bars = createBars();
            
            for (let i = 0; i < bars.length; i++) {
                const dataIdx = Math.floor(i * dataArray.length / bars.length);
                const value = dataArray[dataIdx] || 0;
                const height = Math.max(4, (value / 255) * 25);
                bars[i].style.height = `${height}px`;
            }

            visualizerId = requestAnimationFrame(updateVisualizer);
        };

        const toggle = async () => {
            if (!isPlaying) {
                const result = initAudioContext();
                if (!result.ok) {
                    console.warn('[Audio] Context failed:', result.error.message);
                }
                
                try {
                    if (audioCtx && audioCtx.state === 'suspended') {
                        await audioCtx.resume();
                    }
                    await audio.play();
                    isPlaying = true;
                    playBtn.classList.add('playing');
                    playIcon.className = 'pause-icon';
                    updateVisualizer();
                } catch (e) {
                    console.warn('[Audio] Playback failed:', e.message);
                }
            } else {
                audio.pause();
                isPlaying = false;
                playBtn.classList.remove('playing');
                playIcon.className = 'play-icon';
                if (visualizerId) cancelAnimationFrame(visualizerId);
            }
        };

        const setup = () => {
            playBtn.addEventListener('click', toggle);
            
            audio.addEventListener('error', (e) => {
                const error = audio.error;
                console.warn(`[Audio] Load failed (code ${error?.code}): Ensure fallen-down.mp3 exists in the same directory`);
                playBtn.style.opacity = '0.4';
                playBtn.style.pointerEvents = 'none';
                playBtn.title = 'Audio file not found';
            });

            audio.addEventListener('canplay', () => {
                console.log('[Audio] File loaded successfully');
            });
        };

        return { setup };
    })();

    // ===== SCROLL REVEAL SYSTEM =====
    const ScrollReveal = (() => {
        const observerOptions = {
            root: null,
            rootMargin: '0px 0px -10% 0px',
            threshold: 0.1
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('visible');
                    observer.unobserve(entry.target);
                }
            });
        }, observerOptions);

        const observe = (selector) => {
            document.querySelectorAll(selector).forEach(el => observer.observe(el));
        };

        return { observe };
    })();

    // ===== LETTER REVEAL =====
    const LetterReveal = (() => {
        const letter = document.getElementById('letter');
        const paragraphs = Array.from(letter.querySelectorAll('p'));

        const revealParagraphs = () => {
            paragraphs.forEach((p, i) => {
                setTimeout(() => p.classList.add('revealed'), i * 300);
            });
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    revealParagraphs();
                    observer.unobserve(entry.target);
                }
            });
        }, { threshold: 0.15 });

        const init = () => observer.observe(letter);

        return { init };
    })();

    // ===== PUNCHLINE REVEAL =====
    const PunchlineReveal = (() => {
        const punchline = document.getElementById('punchline');
        const signature = document.getElementById('signature');

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    punchline.classList.add('revealed');
                    setTimeout(() => signature.classList.add('revealed'), 600);
                    observer.unobserve(entry.target);
                }
            });
        }, { threshold: 0.4 });

        const init = () => observer.observe(punchline);

        return { init };
    })();

    // ===== IMAGE FALLBACK SYSTEM =====
    const ImageFallback = (() => {
        const frames = ['frame-k1', 'frame-k2', 'frame-k3'];

        const handleImageError = (img, fallback, src) => {
            img.style.display = 'none';
            fallback.classList.add('visible');
            console.warn(`[Image] Failed to load: ${src}`);
        };

        const setup = () => {
            frames.forEach(id => {
                const frame = document.getElementById(id);
                if (!frame) return;
                
                const img = frame.querySelector('img');
                const fallback = frame.querySelector('.image-fallback');
                
                if (img && fallback) {
                    const src = img.src;
                    img.addEventListener('error', () => handleImageError(img, fallback, src));
                    
                    if (img.complete && img.naturalWidth === 0) {
                        handleImageError(img, fallback, src);
                    }
                }
            });
        };

        return { setup };
    })();

    // ===== ENTRY PORTAL =====
    const EntryPortal = (() => {
        const portal = document.getElementById('portal');
        const enterBtn = document.getElementById('enter-btn');
        const universe = document.getElementById('universe');
        const portalTitle = document.getElementById('portal-title');
        const portalSubtitle = document.getElementById('portal-subtitle');

        const animateEntrance = () => {
            requestAnimationFrame(() => {
                portalTitle.classList.add('visible');
                setTimeout(() => portalSubtitle.classList.add('visible'), 200);
                setTimeout(() => enterBtn.classList.add('visible'), 400);
            });
        };

        const dissolve = () => {
            portal.classList.add('dissolved');
            setTimeout(() => {
                universe.classList.add('revealed');
                ScrollReveal.observe('.scroll-reveal');
            }, 300);
        };

        const init = () => {
            animateEntrance();
            enterBtn.addEventListener('click', dissolve);
        };

        return { init };
    })();

    // ===== FLOATING PARTICLES =====
    const FloatingParticles = (() => {
        const PARTICLE_COUNT = 15;
        const particles = [];

        const createParticle = () => {
            const p = document.createElement('div');
            p.className = 'particle';
            p.style.left = `${Math.random() * 100}vw`;
            p.style.top = `${Math.random() * 100}vh`;
            document.body.appendChild(p);
            return {
                el: p,
                x: parseFloat(p.style.left),
                y: parseFloat(p.style.top),
                vx: (Math.random() - 0.5) * 0.02,
                vy: (Math.random() - 0.5) * 0.02 - 0.01,
                opacity: 0,
                phase: Math.random() * Math.PI * 2
            };
        };

        const animate = () => {
            const time = Date.now() * 0.001;
            
            particles.forEach(p => {
                p.x += p.vx;
                p.y += p.vy;
                p.opacity = 0.3 + 0.3 * Math.sin(time + p.phase);

                if (p.x < 0) p.x = 100;
                if (p.x > 100) p.x = 0;
                if (p.y < 0) p.y = 100;
                if (p.y > 100) p.y = 0;

                p.el.style.left = `${p.x}vw`;
                p.el.style.top = `${p.y}vh`;
                p.el.style.opacity = p.opacity;
            });

            requestAnimationFrame(animate);
        };

        const init = () => {
            for (let i = 0; i < PARTICLE_COUNT; i++) {
                particles.push(createParticle());
            }
            animate();
        };

        return { init };
    })();

    // ===== MAIN INITIALIZATION =====
    const init = () => {
        Starfield.init();
        EntryPortal.init();
        AudioSystem.setup();
        ImageFallback.setup();
        LetterReveal.init();
        PunchlineReveal.init();
        FloatingParticles.init();

        console.log('[System] All modules initialized successfully');
    };

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }
    </script>
</body>
</html>
arseFloat(p.style.left),
                y: parseFloat(p.style.top),
                vx: (Math.random() - 0.5) * 0.02,
                vy: (Math.random() - 0.5) * 0.02 - 0.01,
                opacity: 0,
                phase: Math.random() * Math.PI * 2
            };
        };

        const animate = () => {
            const time = Date.now() * 0.001;
            
            particles.forEach(p => {
                p.x += p.vx;
                p.y += p.vy;
                p.opacity = 0.3 + 0.3 * Math.sin(time + p.phase);

                // Wrap around
                if (p.x < 0) p.x = 100;
                if (p.x > 100) p.x = 0;
                if (p.y < 0) p.y = 100;
                if (p.y > 100) p.y = 0;

                p.el.style.left = `${p.x}vw`;
                p.el.style.top = `${p.y}vh`;
                p.el.style.opacity = p.opacity;
            });

            requestAnimationFrame(animate);
        };

        const init = () => {
            for (let i = 0; i < PARTICLE_COUNT; i++) {
                particles.push(createParticle());
            }
            animate();
        };

        return { init };
    })();

    // ===== MAIN INITIALIZATION =====
    const init = () => {
        // Start systems in order of priority
        Starfield.init();
        EntryPortal.init();
        AudioSystem.setup();
        ImageFallback.setup();
        LetterReveal.init();
        PunchlineReveal.init();
        FloatingParticles.init();

        console.log('[System] All modules initialized successfully');
    };

    // Initialize immediately if ready, otherwise wait
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
    } else {
        init();
    }
    </script>
</body>
</html>
